import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Textarea } from "@/components/ui/textarea";
import {
  Clock,
  Check,
  X,
  Star,
  Users,
  Camera,
  Image as ImageIcon,
  Calendar,
  MessageCircle,
  TrendingUp,
  Award,
  Settings,
  User as UserIcon,
  Scissors,
} from "lucide-react";
import { User, Booking } from "@shared/api";
import { cn } from "@/lib/utils";
import { useAppStore } from "@/lib/store";
import apiClient from "@/lib/api";
import FriendsPage from "./FriendsPage";
import UserProfile from "./UserProfile";
import ServicesManagement from "./ServicesManagement";
import WorkingHours from "./WorkingHours";
import AnalyticsDashboard from "./AnalyticsDashboard";
import SettingsPage from "./SettingsPage";
import EditProfilePage from "./EditProfilePage";
import MessagesPage from "./MessagesPage";

interface BarberDashboardProps {
  user: User;
  activeTab: string;
  onLogout?: () => void;
}

export default function BarberDashboard({
  user,
  activeTab,
  onLogout,
}: BarberDashboardProps) {
  const [state, store] = useAppStore();
  const [newPostCaption, setNewPostCaption] = useState("");
  const [selectedImage, setSelectedImage] = useState<File | null>(null);

  // Followers system state
  const [followers, setFollowers] = useState<any[]>([]);
  const [following, setFollowing] = useState<any[]>([]);
  const [followerCount, setFollowerCount] = useState(0);
  const [followingCount, setFollowingCount] = useState(0);
  const [showFollowers, setShowFollowers] = useState(false);
  const [showFollowing, setShowFollowing] = useState(false);

  const uploadImage = async (file: File): Promise<string> => {
    try {
      // Try to upload using API client
      const response = await apiClient.uploadImage(file);
      return response.url;
    } catch (error) {
      // Fallback to base64 if upload API not available
      console.warn(
        "Image upload API not available, using base64 fallback:",
        error,
      );
      return await convertToBase64(file);
    }
  };

  const convertToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result as string;
        console.log("Image converted to base64");
        resolve(result);
      };
      reader.onerror = () => {
        reject(new Error("Failed to read image file"));
      };
      reader.readAsDataURL(file);
    });
  };
  const [selectedProfile, setSelectedProfile] = useState<any | null>(null);
  const [showProfile, setShowProfile] = useState(false);
  const [showServicesManagement, setShowServicesManagement] = useState(false);
  const [showWorkingHours, setShowWorkingHours] = useState(false);
  const [showAnalytics, setShowAnalytics] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEditProfile, setShowEditProfile] = useState(false);
  const [showMessages, setShowMessages] = useState(false);
  const [messageTargetUser, setMessageTargetUser] = useState<any | null>(null);

  // Load data on component mount
  useEffect(() => {
    loadBarberData();
    loadFollowersData();
  }, [user.id]);

  const loadFollowersData = async () => {
    try {
      // Load followers and following data
      const [followersResponse, followingResponse] = await Promise.all([
        apiClient.getFollows("followers"),
        apiClient.getFollows("following"),
      ]);

      const followersData = followersResponse.follows || [];
      const followingData = followingResponse.follows || [];

      setFollowers(followersData);
      setFollowing(followingData);
      setFollowerCount(followersData.length);
      setFollowingCount(followingData.length);
    } catch (error) {
      console.error("Error loading followers data:", error);
      setFollowers([]);
      setFollowing([]);
      setFollowerCount(0);
      setFollowingCount(0);
    }
  };

  const loadBarberData = async () => {
    // Only load if user is logged in
    if (!user?.id) {
      return;
    }

    try {
      store.setLoading(true);

      // Load data sequentially to prevent network overload
      try {
        const bookingsData = await apiClient.getBookings();
        store.setBookings(bookingsData.bookings || []);
      } catch (error) {
        console.error("Error loading bookings:", error);
        store.setBookings([]);
      }

      try {
        const postsData = await apiClient.getPosts(user.id);
        store.setPosts(postsData.posts || []);
      } catch (error) {
        console.error("Error loading posts:", error);
        store.setPosts([]);
      }
    } catch (error) {
      console.error("Error loading barber data:", error);
    } finally {
      store.setLoading(false);
    }
  };

  const getLevelIcon = (level: number) => {
    if (level >= 100) return "üü†";
    if (level >= 51) return "üü°";
    if (level >= 21) return "üîπ";
    return "üî∏";
  };

  const getLevelLabel = (level: number) => {
    if (level >= 100) return "VIP";
    if (level >= 51) return "ÿ∞Ÿáÿ®Ÿä";
    if (level >= 21) return "ŸÖÿ≠ÿ™ÿ±ŸÅ";
    return "ŸÖÿ®ÿ™ÿØÿ¶";
  };

  // Show profile page
  if (showProfile && selectedProfile) {
    return (
      <UserProfile
        profileUser={selectedProfile}
        currentUser={user}
        onBack={() => {
          setShowProfile(false);
          setSelectedProfile(null);
        }}
        onMessage={() => {
          setShowProfile(false);
          setMessageTargetUser(selectedProfile);
          setShowMessages(true);
        }}
      />
    );
  }

  // Show services management
  if (showServicesManagement) {
    return (
      <ServicesManagement
        user={user}
        onBack={() => setShowServicesManagement(false)}
      />
    );
  }

  // Show working hours
  if (showWorkingHours) {
    return (
      <WorkingHours user={user} onBack={() => setShowWorkingHours(false)} />
    );
  }

  // Show analytics
  if (showAnalytics) {
    return (
      <AnalyticsDashboard user={user} onBack={() => setShowAnalytics(false)} />
    );
  }

  // Show settings
  if (showSettings) {
    return <SettingsPage user={user} onBack={() => setShowSettings(false)} />;
  }

  // Show edit profile
  if (showEditProfile) {
    return (
      <EditProfilePage
        user={user}
        onBack={() => setShowEditProfile(false)}
        onSave={(updatedUser) => {
          setShowEditProfile(false);
        }}
      />
    );
  }

  // Show messages
  if (showMessages) {
    return (
      <MessagesPage
        user={user}
        targetUser={messageTargetUser}
        onBack={() => {
          setShowMessages(false);
          setMessageTargetUser(null);
        }}
      />
    );
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString("ar-SA", {
      weekday: "long",
      day: "numeric",
      month: "long",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  const formatRelativeTime = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor(
      (now.getTime() - date.getTime()) / (1000 * 60 * 60),
    );

    if (diffInHours < 1) return "ŸÖŸÜÿ∞ ÿØŸÇÿßÿ¶ŸÇ";
    if (diffInHours < 24) return `ŸÖŸÜÿ∞ ${diffInHours} ÿ≥ÿßÿπÿ©`;
    const diffInDays = Math.floor(diffInHours / 24);
    return `ŸÖŸÜÿ∞ ${diffInDays} ŸäŸàŸÖ`;
  };

  const handleAcceptBooking = async (bookingId: string) => {
    try {
      await apiClient.updateBooking(bookingId, { status: "accepted" });
      store.updateBooking(bookingId, { status: "accepted" });

      // Add notification
      const booking = state.bookings.find((b) => b.id === bookingId);
      if (booking) {
        store.addNotification({
          id: Date.now().toString(),
          type: "booking_accepted",
          title: "ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ≠ÿ¨ÿ≤",
          message: `ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿ≠ÿ¨ÿ≤ ${booking.user?.name || "ÿßŸÑÿπŸÖŸäŸÑ"}`,
          data: booking,
          read: false,
          created_at: new Date().toISOString(),
        });
      }
    } catch (error) {
      console.error("Error accepting booking:", error);
    }
  };

  const handleRejectBooking = async (bookingId: string) => {
    try {
      await apiClient.updateBooking(bookingId, { status: "rejected" });
      store.updateBooking(bookingId, { status: "rejected" });

      // Add notification
      const booking = state.bookings.find((b) => b.id === bookingId);
      if (booking) {
        store.addNotification({
          id: Date.now().toString(),
          type: "booking_rejected",
          title: "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ≠ÿ¨ÿ≤",
          message: `ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ≠ÿ¨ÔøΩÔøΩ ${booking.user?.name || "ÿßŸÑÿπŸÖŸäŸÑ"}`,
          data: booking,
          read: false,
          created_at: new Date().toISOString(),
        });
      }
    } catch (error) {
      console.error("Error rejecting booking:", error);
    }
  };

  const handleCreatePost = async () => {
    if (!selectedImage || !newPostCaption.trim()) return;

    try {
      store.setLoading(true);

      // Upload image to get real URL
      const imageUrl = await uploadImage(selectedImage);

      const postData = {
        user_id: user.id,
        image_url: imageUrl,
        caption: newPostCaption,
        frame_style: getLevelLabel(user.level),
      };

      const newPost = await apiClient.createPost(postData);

      // Ensure the post has complete user data
      const enrichedPost = {
        ...newPost,
        user: user, // Add complete user data
        likes: 0, // Initialize likes
      };

      store.addPost(enrichedPost);

      setNewPostCaption("");
      setSelectedImage(null);

      // Force refresh posts in other components by dispatching event
      window.dispatchEvent(new CustomEvent("postsUpdated"));

      // Update user points for creating post
      const updatedUser = { ...user, points: user.points + 5 };
      store.setUser(updatedUser);

      // Add success notification
      store.addNotification({
        id: Date.now().toString(),
        type: "success",
        title: "ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±",
        message: "ÿ™ŸÖ ŸÜÿ¥ÿ± ÿπŸÖŸÑŸÉ ÿ®ŸÜÿ¨ÿßÿ≠ Ÿàÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 5 ŸÜŸÇÿßÿ∑",
        data: null,
        read: false,
        created_at: new Date().toISOString(),
      });
    } catch (error) {
      console.error("Error creating post:", error);
    } finally {
      store.setLoading(false);
    }
  };

  const handleViewProfile = (customer: any) => {
    setSelectedProfile({
      ...customer,
      role: "customer",
      status: "active",
      is_verified: true,
      created_at: new Date().toISOString(),
    });
    setShowProfile(true);
  };

  const renderHome = () => (
    <div className="p-4 space-y-6">
      {/* Stats Cards */}
      <div className="grid grid-cols-2 gap-4">
        <Card className="border-border/50 bg-card/50">
          <CardContent className="p-4 text-center">
            <TrendingUp className="h-8 w-8 text-primary mx-auto mb-2" />
            <p className="text-2xl font-bold text-foreground">{user.points}</p>
            <p className="text-sm text-muted-foreground">ŸÜŸÇÿßÿ∑</p>
          </CardContent>
        </Card>

        <Card className="border-border/50 bg-card/50">
          <CardContent className="p-4 text-center">
            <Award className="h-8 w-8 text-golden-500 mx-auto mb-2" />
            <p className="text-lg font-bold text-foreground flex items-center justify-center gap-1">
              {getLevelIcon(user.level)}
              {getLevelLabel(user.level)}
            </p>
            <p className="text-sm text-muted-foreground">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</p>
          </CardContent>
        </Card>
      </div>

      {/* Recent Booking Requests */}
      <Card className="border-border/50 bg-card/50">
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2">
            <MessageCircle className="h-5 w-5" />
            ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿßŸÑÿ¨ÿØŸäÿØÿ©
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {state.bookings
            .filter((b) => b.status === "pending")
            .slice(0, 2)
            .map((booking) => (
              <div
                key={booking.id}
                className="flex items-center gap-3 p-3 bg-muted/30 rounded-lg"
              >
                <Avatar
                  className="h-10 w-10 cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() =>
                    booking.user && handleViewProfile(booking.user)
                  }
                >
                  <AvatarImage src={booking.user?.avatar_url} />
                  <AvatarFallback className="bg-primary/10 text-primary">
                    {booking.user?.name ? booking.user.name.charAt(0) : "ÿπ"}
                  </AvatarFallback>
                </Avatar>

                <div className="flex-1 min-w-0">
                  <p
                    className="font-medium text-foreground text-sm cursor-pointer hover:text-primary transition-colors"
                    onClick={() =>
                      booking.user && handleViewProfile(booking.user)
                    }
                  >
                    {booking.user?.name || "ÿπŸÖŸäŸÑ"}
                  </p>
                  <p className="text-xs text-muted-foreground">
                    {formatDate(booking.datetime)}
                  </p>
                </div>

                <div className="flex gap-1">
                  <Button
                    size="sm"
                    className="h-7 px-2"
                    onClick={() => handleAcceptBooking(booking.id)}
                  >
                    <Check className="h-3 w-3" />
                  </Button>
                  <Button
                    size="sm"
                    variant="outline"
                    className="h-7 px-2"
                    onClick={() => handleRejectBooking(booking.id)}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </div>
              </div>
            ))}

          {state.bookings.filter((b) => b.status === "pending").length ===
            0 && (
            <p className="text-center text-muted-foreground py-4">
              ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ¨ÿØŸäÿØÿ©
            </p>
          )}
        </CardContent>
      </Card>

      {/* Recent Posts Performance */}
      <Card className="border-border/50 bg-card/50">
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2">
            <ImageIcon className="h-5 w-5" />
            ÿ¢ÿÆÿ± ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ŸÉ
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {state.posts.slice(0, 2).map((post) => (
            <div key={post.id} className="flex gap-3">
              <div className="w-16 h-16 bg-muted rounded-lg flex items-center justify-center overflow-hidden">
                <img
                  src={post.image_url}
                  alt="Post"
                  className="w-full h-full object-cover"
                />
              </div>

              <div className="flex-1">
                <p className="text-sm text-foreground mb-1">{post.caption}</p>
                <div className="flex items-center gap-4 text-xs text-muted-foreground">
                  <span>‚ù§Ô∏è {post.likes}</span>
                  <span>üí¨ {post.comments}</span>
                  <span>{formatRelativeTime(post.created_at)}</span>
                </div>
              </div>
            </div>
          ))}
        </CardContent>
      </Card>
    </div>
  );

  const renderRequests = () => (
    <div className="p-4 space-y-6">
      <h2 className="text-xl font-bold text-foreground">ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤</h2>

      <div className="space-y-4">
        {state.bookings
          .filter((b) => b.status === "pending")
          .map((booking) => (
            <Card key={booking.id} className="border-border/50 bg-card/50">
              <CardContent className="p-4">
                <div className="flex items-start gap-4">
                  <Avatar className="h-12 w-12">
                    <AvatarImage src={booking.user?.avatar_url} />
                    <AvatarFallback className="bg-primary/10 text-primary">
                      {booking.user?.name ? booking.user.name.charAt(0) : "ÿπ"}
                    </AvatarFallback>
                  </Avatar>

                  <div className="flex-1 space-y-2">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium text-foreground">
                        {booking.user?.name || "ÿπŸÖŸäŸÑ"}
                      </h4>
                      <Badge variant="outline" className="text-xs">
                        <Clock className="h-3 w-3 mr-1" />
                        ÿ¨ÿØŸäÿØ
                      </Badge>
                    </div>

                    <div className="text-sm text-muted-foreground">
                      <div className="flex items-center gap-2 mb-1">
                        <Calendar className="h-4 w-4" />
                        {formatDate(booking.datetime)}
                      </div>
                    </div>

                    <div className="flex gap-2 pt-2">
                      <Button
                        size="sm"
                        className="flex-1"
                        onClick={() => handleAcceptBooking(booking.id)}
                      >
                        <Check className="h-4 w-4 mr-1" />
                        ŸÇÿ®ŸàŸÑ
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        className="flex-1"
                        onClick={() => handleRejectBooking(booking.id)}
                      >
                        <X className="h-4 w-4 mr-1" />
                        ÿ±ŸÅÿ∂
                      </Button>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}

        {state.bookings.filter((b) => b.status === "pending").length === 0 && (
          <Card className="border-border/50 bg-card/50">
            <CardContent className="p-8 text-center">
              <MessageCircle className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-medium text-foreground mb-2">
                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ¨ÿØŸäÿØÿ©
              </h3>
              <p className="text-muted-foreground">
                ÿ≥Ÿäÿ∏Ÿáÿ± ŸáŸÜÿß ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ°
              </p>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Accepted Bookings */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-foreground">
          ÿßŸÑŸÖŸàÿßÿπŸäÿØ ÿßŸÑŸÖÿ§ŸÉÿØÿ©
        </h3>

        {state.bookings
          .filter((b) => b.status === "accepted")
          .map((booking) => (
            <Card key={booking.id} className="border-border/50 bg-card/50">
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Avatar className="h-10 w-10">
                      <AvatarImage src={booking.user?.avatar_url} />
                      <AvatarFallback className="bg-green-500/10 text-green-500">
                        {booking.user?.name ? booking.user.name.charAt(0) : "ÿπ"}
                      </AvatarFallback>
                    </Avatar>

                    <div>
                      <h4 className="font-medium text-foreground">
                        {booking.user?.name || "ÿπŸÖŸäŸÑ"}
                      </h4>
                      <p className="text-sm text-muted-foreground">
                        {formatDate(booking.datetime)}
                      </p>
                    </div>
                  </div>

                  <Badge className="bg-green-500/10 text-green-500 border-green-500/20">
                    ŸÖÿ§ŸÉÿØ
                  </Badge>
                </div>
              </CardContent>
            </Card>
          ))}
      </div>
    </div>
  );

  const renderNewPost = () => (
    <div className="p-4 space-y-6">
      <h2 className="text-xl font-bold text-foreground">ŸÖŸÜÿ¥Ÿàÿ± ÿ¨ÿØŸäÿØ</h2>

      <Card className="border-border/50 bg-card/50">
        <CardContent className="p-6 space-y-4">
          {/* Image Upload */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">
              ÿßŸÑÿµŸàÿ±ÿ©
            </label>
            <div className="border-2 border-dashed border-border rounded-lg p-8 text-center">
              {selectedImage ? (
                <div className="space-y-2">
                  <div className="w-32 h-32 mx-auto bg-muted rounded-lg flex items-center justify-center">
                    <ImageIcon className="h-12 w-12 text-muted-foreground" />
                  </div>
                  <p className="text-sm text-foreground">
                    {selectedImage.name}
                  </p>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setSelectedImage(null)}
                  >
                    ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©
                  </Button>
                </div>
              ) : (
                <div className="space-y-2">
                  <Camera className="h-12 w-12 text-muted-foreground mx-auto" />
                  <p className="text-foreground font-medium">ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©</p>
                  <p className="text-sm text-muted-foreground">
                    PNG, JPG, GIF - ÿ≠ÿ™Ÿâ 10MB
                  </p>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() =>
                      document.getElementById("image-upload")?.click()
                    }
                  >
                    ÿ±ŸÅÿπ ÿµŸàÿ±ÿ©
                  </Button>
                  <input
                    id="image-upload"
                    type="file"
                    accept="image/*"
                    style={{ display: "none" }}
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) {
                        // Validate file type
                        const validTypes = [
                          "image/jpeg",
                          "image/jpg",
                          "image/png",
                          "image/gif",
                        ];
                        if (!validTypes.includes(file.type)) {
                          store.addNotification({
                            id: Date.now().toString(),
                            type: "system",
                            title: "ŸÜŸàÿπ ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ",
                            message: "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© ÿ®ÿµŸäÿ∫ÿ© JPG, PNG ÿ£Ÿà GIF",
                            data: null,
                            read: false,
                            created_at: new Date().toISOString(),
                          });
                          return;
                        }

                        // Validate file size (10MB limit)
                        const maxSize = 10 * 1024 * 1024; // 10MB
                        if (file.size > maxSize) {
                          store.addNotification({
                            id: Date.now().toString(),
                            type: "system",
                            title: "ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã",
                            message: "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© ÿ®ÿ≠ÿ¨ŸÖ ÿ£ŸÇŸÑ ŸÖŸÜ 10 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™",
                            data: null,
                            read: false,
                            created_at: new Date().toISOString(),
                          });
                          return;
                        }

                        setSelectedImage(file);
                      }
                    }}
                  />
                </div>
              )}
            </div>
          </div>

          {/* Caption */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">ÿßŸÑŸàÿµŸÅ</label>
            <Textarea
              value={newPostCaption}
              onChange={(e) => setNewPostCaption(e.target.value)}
              placeholder="ÿßŸÉÿ™ÿ® ŸàÿµŸÅÿßŸã ŸÑÔøΩÔøΩŸÖŸÑŸÉ..."
              className="min-h-[100px] text-right"
              dir="rtl"
            />
          </div>

          {/* Frame Preview */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">
              ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±
            </label>
            <div className="p-4 border border-border rounded-lg bg-muted/30">
              <div className="flex items-center gap-2 mb-2">
                <span>{getLevelIcon(user.level)}</span>
                <span className="text-sm font-medium">
                  {getLevelLabel(user.level)}
                </span>
              </div>
              <p className="text-xs text-muted-foreground">
                ÿ•ÿ∑ÿßÿ± {getLevelLabel(user.level)} - Ÿäÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇŸá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ≠ÿ≥ÿ®
                ŸÖÿ≥ÿ™ŸàÿßŸÉ
              </p>
            </div>
          </div>

          <Button
            className="w-full bg-primary hover:bg-primary/90"
            onClick={handleCreatePost}
            disabled={!selectedImage || !newPostCaption.trim()}
          >
            ŸÜÿ¥ÿ±
          </Button>
        </CardContent>
      </Card>
    </div>
  );

  const renderProfile = () => (
    <div className="p-4 space-y-6">
      <Card className="border-border/50 bg-card/50">
        <CardContent className="p-6">
          <div className="flex items-center gap-4 mb-6">
            <Avatar className="h-20 w-20">
              <AvatarImage src={user.avatar_url} />
              <AvatarFallback className="bg-primary/10 text-primary text-xl">
                {user.name.charAt(0)}
              </AvatarFallback>
            </Avatar>
            <div className="space-y-1">
              <h3 className="text-xl font-bold text-foreground">{user.name}</h3>
              <p className="text-muted-foreground">{user.email}</p>
              <div className="flex items-center gap-2">
                <Badge variant="outline">ÿ≠ŸÑÿßŸÇ</Badge>
                <Badge className="bg-golden-500/10 text-golden-500 border-golden-500/20">
                  {getLevelIcon(user.level)} {getLevelLabel(user.level)}
                </Badge>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-4 gap-3 text-center">
            <div>
              <p className="text-2xl font-bold text-primary">{user.points}</p>
              <p className="text-sm text-muted-foreground">ŸÜŸÇÔøΩÔøΩÿ∑</p>
            </div>
            <div
              className="cursor-pointer hover:bg-muted/50 p-2 rounded transition-colors"
              onClick={() => setShowFollowers(true)}
            >
              <p className="text-2xl font-bold text-primary">{followerCount}</p>
              <p className="text-sm text-muted-foreground">ŸÖÿ™ÿßÿ®ÿπÔøΩÔøΩŸÜ</p>
            </div>
            <div
              className="cursor-pointer hover:bg-muted/50 p-2 rounded transition-colors"
              onClick={() => setShowFollowing(true)}
            >
              <p className="text-2xl font-bold text-primary">
                {followingCount}
              </p>
              <p className="text-sm text-muted-foreground">ŸÖÿ™ÿßÿ®ŸéÿπŸäŸÜ</p>
            </div>
            <div>
              <p className="text-2xl font-bold text-primary">
                {state.posts.length}
              </p>
              <p className="text-sm text-muted-foreground">ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Posts Grid */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-foreground">ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™Ÿä</h3>

        <div className="grid grid-cols-3 gap-2">
          {state.posts.map((post) => (
            <div
              key={post.id}
              className="aspect-square bg-muted rounded-lg overflow-hidden"
            >
              <img
                src={post.image_url}
                alt="Post"
                className="w-full h-full object-cover"
              />
            </div>
          ))}

          {Array.from({ length: Math.max(0, 6 - state.posts.length) }).map(
            (_, i) => (
              <div
                key={i}
                className="aspect-square bg-muted/30 rounded-lg flex items-center justify-center"
              >
                <ImageIcon className="h-6 w-6 text-muted-foreground" />
              </div>
            ),
          )}
        </div>
      </div>

      {/* Business Management */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-foreground">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿπŸÖÿßŸÑ</h3>
        <div className="space-y-2">
          <Button
            variant="outline"
            className="w-full justify-start gap-3"
            onClick={() => setShowServicesManagement(true)}
          >
            <Scissors className="h-4 w-4" />
            ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿÆÿØŸÖÿßÿ™
          </Button>
          <Button
            variant="outline"
            className="w-full justify-start gap-3"
            onClick={() => setShowWorkingHours(true)}
          >
            <Clock className="h-4 w-4" />
            ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ
          </Button>
          <Button
            variant="outline"
            className="w-full justify-start gap-3"
            onClick={() => setShowAnalytics(true)}
          >
            <TrendingUp className="h-4 w-4" />
            ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
          </Button>
        </div>
      </div>

      {/* Settings and Logout */}
      <div className="space-y-2">
        <Button
          variant="outline"
          className="w-full justify-start gap-3"
          onClick={() => setShowSettings(true)}
        >
          <Settings className="h-4 w-4" />
          ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        </Button>
        <Button
          variant="outline"
          className="w-full justify-start gap-3"
          onClick={() => setShowEditProfile(true)}
        >
          <UserIcon className="h-4 w-4" />
          ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÔøΩÔøΩŸä
        </Button>
        <Button
          variant="destructive"
          className="w-full justify-start gap-3"
          onClick={onLogout}
        >
          ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨
        </Button>
      </div>
    </div>
  );

  const renderFollowers = () => (
    <div className="p-4 space-y-6">
      <div className="flex items-center gap-4 mb-6">
        <Button
          variant="ghost"
          size="icon"
          onClick={() => setShowFollowers(false)}
        >
          <X className="h-4 w-4" />
        </Button>
        <h2 className="text-lg font-bold">ÿßŸÑŸÖÿ™ÿßÿ®ÿπŸäŸÜ ({followerCount})</h2>
      </div>

      <div className="space-y-3">
        {followers.map((follower) => (
          <Card
            key={follower.follower_id}
            className="border-border/50 bg-card/50"
          >
            <CardContent className="p-4">
              <div className="flex items-center gap-3">
                <Avatar className="h-12 w-12">
                  <AvatarImage src={follower.follower?.avatar_url} />
                  <AvatarFallback className="bg-primary/10 text-primary">
                    {follower.follower?.name?.charAt(0) || "ŸÖ"}
                  </AvatarFallback>
                </Avatar>
                <div className="flex-1">
                  <h4 className="font-medium">
                    {follower.follower?.name ||
                      `ŸÖÿ≥ÿ™ÿÆÔøΩÔøΩŸÖ ${follower.follower_id.slice(-4)}`}
                  </h4>
                  <p className="text-sm text-muted-foreground">
                    {follower.follower?.role === "barber" ? "ÿ≠ŸÑÿßŸÇ" : "ÿ≤ÿ®ŸàŸÜ"}
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}

        {followers.length === 0 && (
          <div className="text-center py-8">
            <Users className="h-12 w-12 text-muted-foreground mx-auto mb-2" />
            <p className="text-muted-foreground">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ™ÿßÿ®ÿπŸäŸÜ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>
          </div>
        )}
      </div>
    </div>
  );

  const renderFollowing = () => (
    <div className="p-4 space-y-6">
      <div className="flex items-center gap-4 mb-6">
        <Button
          variant="ghost"
          size="icon"
          onClick={() => setShowFollowing(false)}
        >
          <X className="h-4 w-4" />
        </Button>
        <h2 className="text-lg font-bold">ÿßŸÑŸÖÿ™ÿßÿ®ŸéÿπŸäŸÜ ({followingCount})</h2>
      </div>

      <div className="space-y-3">
        {following.map((follow) => (
          <Card
            key={follow.followed_id}
            className="border-border/50 bg-card/50"
          >
            <CardContent className="p-4">
              <div className="flex items-center gap-3">
                <Avatar className="h-12 w-12">
                  <AvatarImage src={follow.followed?.avatar_url} />
                  <AvatarFallback className="bg-primary/10 text-primary">
                    {follow.followed?.name?.charAt(0) || "ŸÖ"}
                  </AvatarFallback>
                </Avatar>
                <div className="flex-1">
                  <h4 className="font-medium">
                    {follow.followed?.name ||
                      `ŸÖÿ≥ÿ™ÿÆÿØŸÖ ${follow.followed_id.slice(-4)}`}
                  </h4>
                  <p className="text-sm text-muted-foreground">
                    {follow.followed?.role === "barber" ? "ÿ≠ŸÑÿßŸÇ" : "ÿ≤ÿ®ŸàŸÜ"}
                  </p>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => handleUnfollow(follow.followed_id)}
                >
                  ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©
                </Button>
              </div>
            </CardContent>
          </Card>
        ))}

        {following.length === 0 && (
          <div className="text-center py-8">
            <Users className="h-12 w-12 text-muted-foreground mx-auto mb-2" />
            <p className="text-muted-foreground">ŸÑÿß ÿ™ÿ™ÿßÿ®ÔøΩÔøΩ ÿ£ÿ≠ÿØ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>
          </div>
        )}
      </div>
    </div>
  );

  const handleUnfollow = async (userId: string) => {
    try {
      await apiClient.unfollowUser(userId);

      // Remove from local state
      setFollowing((prev) => prev.filter((f) => f.followed_id !== userId));
      setFollowingCount((prev) => prev - 1);

      // Update store
      const followToRemove = state.follows.find(
        (f) => f.followed_id === userId,
      );
      if (followToRemove) {
        store.removeFollow(followToRemove.id);
      }

      // Add notification
      store.addNotification({
        id: Date.now().toString(),
        type: "friend_request",
        title: "ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©",
        message: "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠",
        data: null,
        read: false,
        created_at: new Date().toISOString(),
      });
    } catch (error) {
      console.error("Error unfollowing:", error);
    }
  };

  // Handle showing followers/following
  if (showFollowers) {
    return renderFollowers();
  }

  if (showFollowing) {
    return renderFollowing();
  }

  switch (activeTab) {
    case "home":
      return renderHome();
    case "friends":
      return <FriendsPage user={user} />;
    case "requests":
      return renderRequests();
    case "new-post":
      return renderNewPost();
    case "profile":
      return renderProfile();
    default:
      return renderHome();
  }
}
